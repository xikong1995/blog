Web 性能优化是一个老生常谈的问题，以前看了很多零碎的知识，所以一直想找个机会好好总结一下。Web 性能优化涉及的面很广，这里我从前端的视角讲一讲优化点，主要分为传输层和渲染层。

这篇文章，我讲述的是网络传输层。

# 输入网址到页面呈现，中间发生了什么
“输入网址到页面呈现，中间发生了什么”这个是很多面试官喜欢问的一个问题。

为什么喜欢问呢？

> 因为这个问题覆盖了很多计算机网络的问题，如果你答得好，那么可以表明你的计算机网络基础还不错。很多性能问题就发生在这个过程中，如果你想很好地优化 Web 应用的性能，那么这期间的细节你一定要了解清楚。

![网络请求](https://img-blog.csdnimg.cn/20201206161513340.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pob3VsZWkxOTk1,size_16,color_FFFFFF,t_70#pic_center)

步骤说明：
1. 解析域名的 IP 地址
2. 建立与目标主机的 TCP 连接
3. 如果是 HTTPS 请求，初始化并完成 TLS 握手
4. 发送请求

# 关键性能指标
下面我们介绍一些关键的性能指标，然后分析如何进行性能优化。

## 延迟
延迟是指 IP 数据包从一个网络端点到另一个网络端点所花费的时间。与之相关的是往返时延(RTT)，它是延迟的时间的两倍。延迟是制约 Web 性能的主要瓶颈，尤其对于 HTTP 这样的协议，因为其中包含大量往返于服务器的请求。

## 带宽
只要带宽没有饱和，两个网络端点之间的连接会一次处理尽可能多的数据量。依据 Web 页面引用资源的大小和网络连接的传输能力，带宽可能会成为性能的瓶颈。

## DNS 查询
在客户端能够获取 Web 页面前，它需要通过域名系统(DNS)把主机名称转换成 IP 地址，DNS 相当于互联网上的电话号码簿。获取的 HTML 页面中所引用的各个不同域名也需要转换；幸运的是，一个域名只需转换一次。

## 建立连接时间
在客户端和服务器之间建立连接需要往返数据应答，称为“三次握手”。握手时间一般与客户端和服务器之间的延迟有关。

1. 握手过程包括客户端向服务器发起一个 SYN 包，
2. 接着服务器返回对应 SYN 的 ACK 响应以及新的 SYN 包，
3. 然后客户端返回对应的 ACK。

![三次握手](https://img-blog.csdnimg.cn/20201206163045380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pob3VsZWkxOTk1,size_16,color_FFFFFF,t_70#pic_center)

## TLS 协商时间
如果客户端发起 HTTPS 连接，它还需要进行传输层安全协议(TLS)协商；TLS 用来取代安全套接层(SSL)。除了服务器和客户端的计算处理耗时之外，TLS 还会造成额外的往返传输。

![SSL握手](https://img-blog.csdnimg.cn/20201207003010521.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pob3VsZWkxOTk1,size_16,color_FFFFFF,t_70#pic_center)

# 优化最佳实践
这里提到的优化技巧来自于雅虎的工程师们。

## DNS 查询优化
在与服务主机建立连接之前，需要先解析域名；那么，解析越快就越好。

在主体页面 HTML 或响应中利用 DNS 预取指令。

```html
<link rel="dns-prefetch" href="//ajax.googleapis.com">
```

## 优化 TCP 连接
开启新连接是一个耗时的过程，如果连接使用 TLS，开销会更高。

1、利用 preconnect 指令，连接在使用之前就已经建立好了，这样处理流程的关键路径上就不必考虑连接时间了。

```html
 <link rel="preconnect" href="//fonts.example.com" crossorigin>
```

2、尽早终止并响应。借助 CDN，在距离请求用户很近的边缘端点上，请求就可以获得响应， 所以可以终止连接，大幅减少建立新连接的通信延迟。

## 避免重定向
重定向通常触发与额外域名建立连接。在无线网络中，一次额外的重定向可能把延迟增加数百毫秒，这不利于用户体验，并最终会影响到网站上的业务。

简单的解决方案就是彻底消灭重定向，因为对于重定向的使用往往并没有合理原因。

## 客户端（本地）缓存
没有什么比直接从本地缓存获取资源来得更快，因为它根本就不需要建立网络连接。生存时间(TTL)指令告诉浏览器应该缓存某个资源多久。

设置客户端缓存 TTL，可以通过 HTTP 首部指定 cache control 以及键 max-age(以秒为单位)，或者 expires 首部。

## 网络边缘的（CDN）缓存
因为所有用户都能从云端的共享缓存受益，所以网络边缘的缓存提供了更快的访问速度，也为网站服务基础设施分担了很大一部分流量。

如果一份资源需要缓存，它必须满足:
- 在多用户间可共享，并且
- 能够接受一定程度的旧数据

## 协商缓存
如果缓存 TTL 过期，客户端会向服务器发起请求。在多数情况下，收到的响应其实和缓存的版本是一样的，重新下载已经在缓存里的内容也是一种浪费。

HTTP 提供条件请求机制，客户端能以有效方式询问服务器：“如果内容变了，请返回内容本身;否则，直接告诉我内容没变。”

使用条件缓存可以通过以下方法：
- 在请求中包含 HTTP 首部 `If-Modified-Since`。仅当最新内容在首部中指定的日期之后被更新过，服务器才返回完整内容；否则只返回 304 响应码，并在响应首部 `Last-Modified` 中附带上新的时间戳 Date 字段。
- 在请求中包含 HTTP 首部 `If-None-Match`，它唯一标识所请求的资源。而 `ETag` 由服务器提供，内嵌于资源的响应首部中。服务器会比较当前实体校验码与请求首部中收到的实体校验码，如果一致，就只返回 304 响应码；否则返回完整内容。

## 压缩和代码极简化
所有的文本内容(HTML、JS、CSS、SVG、XML、JSON、字体等)，可以从压缩和极简化中受益。这两种方法组合起来，可以显著减少资源大小。更少字节数对应着更少的请求-应答，也就意味着更短的请求时间。

极简化(minification)是指从文本资源中剥离所有非核心内容的过程。通常，这些内容是开发人员敲出来的，所以要考虑方便人类阅读和维护，比如代码注释。

## 避免阻塞 CSS 和 JS
CSS 的作用是告诉浏览器以什么方式在可视区域的哪个部分渲染内容。所以，在屏幕上绘制第一个像素之前，浏览器必须确保 CSS 已经下载完整。尽管浏览器的预处理器很智能，会尽早请求整个页面所需要的 CSS，但是把 CSS 资源请求放在页面靠前的部分仍然是种最佳实践，具体位置是在文档的 head 标签里，而且要在任何 JS 或图片被请求和处理之前。

默认情况下，如果在 HTML 中定位了 JS，它就会被请求、解析，然后执行。在浏览器处理完这个 JS 之前，会阻止其后任何资源的下载渲染。

如果 JS 执行顺序无关紧要，并且必须在 onload 事件触发之前运行，那么可以设置 async 属性，像这样:

```js
<script async src="/js/myfile.js"></script>
```

如果 JS 执行顺序很重要，并且你也能承受脚本在 DOM 加载完之后运行，那么请使用 defer 属性。像这样:

```js
<script defer src="/js/myjs.js"></script>
```

## 图片优化
对大多数网站而言，图片的相对重要性和绝对重要性都在不断增加。既然图片主导了多数现代网站，优化它们就能够获得最大的性能回报。

> 所有图片优化手段的目标都是在达到指定视觉质量的前提下传输最少的字节。

- 图片元信息，例如题材地理位置信息、时间戳、尺寸和像素信息，通常包含在二进制数据里，应该在发送给客户端之前去掉(务必保留版权和色彩描述信息)。这种无损处理能够在图片生成时完成。对于 PNG 图片，一般会节省大概 10% 的空间。
- 图片过载(image overloading)是指，图片最终被浏览器自动缩小，要么因为原始尺寸超过了浏览器可视区中的占位大小，要么因为像素超过设备的显示能力。这不仅浪费带宽，消耗的 CPU 资源也很可观，这些计算资源有时在手持设备上相当宝贵。想要解决图片过载，可以使用技术手段，针对用户的设备、网络状况和预期的视觉质量，提供裁剪过的图片(就尺寸和质量而言)。

## HTTP/2 不再适用的方法
1. 生成精灵图和资源合并/内联
2. 域名拆分
3. 禁用 cookie 的域名

> 为什么这些方式在 HTTP/2 中不再适用呢？

我们来看一看 HTTP/2 的特点：
1. 二进制协议：HTTP/2 的分帧层是基于帧的二进制协议，这方便了机器解析。
2. 多路复用：HTTP2 让所有的通信都在一个 TCP 连接上完成，真正实现了请求的并发。
3. 首部压缩：HTTP/2 的首部还会被深度压缩，这将显著减少传输中的冗余字节。
4. 加密传输：HTTP/2 希望能营造更加安全的 Web 安全，所以主要基于 SSL。
5. 主动推送：服务器可以主动推送消息给客户端。

由于 HTTP/2 支持多路复用，那么发送多个请求不再是性能瓶颈。同时，HTTP/2 强制首部压缩，所以即使携带 cookie 影响也不大。

# 总结
优化是一件永远都做不完的事，因为随着时代的发展，人们会提出更高的要求。**永远保持一颗谦卑的心，不断学习。**

本文是我阅读的一些总结，尽管我参考了市面上优质的书籍，但是由于个人主观臆断与写作能力的不足，出错在所难免，希望大家多多包涵。

---

参考：
- [HTTP/2基础教程](https://book.douban.com/subject/27665112/)
- [高性能网站建设指南](https://book.douban.com/subject/3132277/)
- [高性能网站建设进阶指南](https://book.douban.com/subject/4719162/)
